rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function userId() {
      return request.auth.uid;
    }

    /**
     * Checks if a user has a specific role in a condominium.
     * The document ID in usuarios_roles is a composite key: {userId}_{condominioId}
     */
    function hasRole(condominioId, role) {
      let roleDocId = userId() + '_' + condominioId;
      return isSignedIn()
        && exists(/databases/$(database)/documents/usuarios_roles/$(roleDocId))
        && get(/databases/$(database)/documents/usuarios_roles/$(roleDocId)).data.role == role;
    }

    /**
     * Checks if a user is any member of a condominium.
     */
    function isMember(condominioId) {
        let roleDocId = userId() + '_' + condominioId;
        return isSignedIn() && exists(/databases/$(database)/documents/usuarios_roles/$(roleDocId));
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    // Users can read and update their own resident profile.
    match /moradores/{moradorId} {
      allow read, update: if isSignedIn() && moradorId == userId();
      // Allow creation for any signed-in user, will be tied to their auth UID.
      allow create: if isSignedIn() && request.resource.data.userId == userId();
      allow delete: if false; // Generally, don't allow users to delete their own profiles.
    }
    
    // User roles are managed only by admins or 'sindicos' of that specific condo.
    match /usuarios_roles/{roleId} {
        allow read: if isMember(resource.data.condominioId);
        allow create, update, delete: if isSignedIn() && hasRole(request.resource.data.condominioId, "sindico");
    }

    // Announcements - read for all members, write only for 'sindico'.
    match /avisos/{avisoId} {
      allow read: if isSignedIn() && isMember(resource.data.condominioId);
      allow create, update, delete: if isSignedIn()
        && hasRole(request.resource.data.condominioId, "sindico");
    }

    // Reservations - resident creates/updates their own, 'sindico' can manage all.
    match /reservas/{reservaId} {
      allow read: if isSignedIn() && isMember(resource.data.condominioId);

      allow create: if isSignedIn()
        && request.resource.data.moradorId == userId()
        && isMember(request.resource.data.condominioId);

      allow update: if isSignedIn() && (
        // Resident can only edit their own pending reservations.
        (resource.data.moradorId == userId() && resource.data.status == "pendente")
        ||
        // 'Sindico' can change status or other details.
        hasRole(resource.data.condominioId, "sindico")
      );

      // A resident can cancel their own reservation, a 'sindico' can cancel any.
      allow delete: if isSignedIn() && (resource.data.moradorId == userId() || hasRole(resource.data.condominioId, "sindico"));
    }

    // Incidents - resident creates their own, 'sindico' reads/manages all.
     match /ocorrencias/{ocorrenciaId} {
        allow read: if isSignedIn() && (resource.data.moradorId == userId() || hasRole(resource.data.condominioId, "sindico"));
        allow list: if isSignedIn() && hasRole(request.query.condominioId, "sindico");
        allow create: if isSignedIn() && request.resource.data.moradorId == userId();
        allow update: if isSignedIn() && hasRole(resource.data.condominioId, "sindico");
        allow delete: if false;
    }

    // Gate Records - only 'porteiro' and 'sindico' can manage.
    match /portaria_registros/{registroId} {
      allow read, create: if isSignedIn()
        && (hasRole(request.resource.data.condominioId, "porteiro")
            || hasRole(request.resource.data.condominioId, "sindico"));
      allow update, delete: if false; // Records should be immutable.
    }
    
    // General condo data (condos, blocks, units) is readable by members and writable by 'sindico'.
    match /condominios/{condominioId} {
        allow read: if isMember(condominioId);
        allow create, update, delete: if hasRole(condominioId, "sindico");
        
        match /blocos/{blocoId} {
            allow read: if isMember(condominioId);
            allow create, update, delete: if hasRole(condominioId, "sindico");
        }
        
        match /unidades/{unidadeId} {
            allow read: if isMember(condominioId);
            allow create, update, delete: if hasRole(condominioId, "sindico");
        }
    }
  }
}
