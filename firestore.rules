rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function userId() {
      return request.auth.uid;
    }

    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(userId()));
    }

    /**
     * Checks if a user has a specific role in a condominium.
     * The document ID in usuarios_roles is a composite key: {userId}_{condominioId}
     */
    function hasRole(condominioId, role) {
      let roleDocId = userId() + '_' + condominioId;
      return isSignedIn()
        && exists(/databases/$(database)/documents/usuarios_roles/$(roleDocId))
        && get(/databases/$(database)/documents/usuarios_roles/$(roleDocId)).data.role == role;
    }

    /**
     * Checks if a user is any member of a condominium.
     */
    function isMember(condominioId) {
        let roleDocId = userId() + '_' + condominioId;
        return isSignedIn() && exists(/databases/$(database)/documents/usuarios_roles/$(roleDocId));
    }


    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    // Users collection:
    // - Admins can read/list all users.
    // - Any signed-in user can read their own document.
    match /users/{uid} {
      allow get: if isSignedIn() && uid == userId();
      allow list, write: if isAdmin();
    }

    // Admin roles can only be managed by other admins.
    match /roles_admin/{uid} {
      allow read, write: if isAdmin();
    }
    
    // User roles are managed only by admins or 'sindicos' of that specific condo.
    match /usuarios_roles/{roleId} {
        allow read: if isMember(resource.data.condominioId);
        allow create, update, delete: if isSignedIn() && (hasRole(request.resource.data.condominioId, "sindico") || isAdmin());
    }

    // Announcements - read for all members, write only for 'sindico'.
    match /condominiums/{condominiumId}/announcements/{announcementId} {
      allow get, list: if isMember(condominiumId);
      allow create, update, delete: if hasRole(condominiumId, "sindico") || isAdmin();
    }

    // Reservations - resident creates/updates their own, 'sindico' can manage all.
    match /reservas/{reservaId} {
      allow read: if isSignedIn() && isMember(resource.data.condominioId);

      allow create: if isSignedIn()
        && request.resource.data.residentId == userId()
        && isMember(request.resource.data.condominiumId);

      allow update: if isSignedIn() && (
        // Resident can only edit their own pending reservations.
        (resource.data.residentId == userId() && resource.data.status == "pendente")
        ||
        // 'Sindico' can change status or other details.
        hasRole(resource.data.condominioId, "sindico") || isAdmin()
      );

      // A resident can cancel their own reservation, a 'sindico' can cancel any.
      allow delete: if isSignedIn() && (resource.data.residentId == userId() || hasRole(resource.data.condominioId, "sindico") || isAdmin());
    }

    // Incidents - resident creates their own, 'sindico' reads/manages all.
     match /ocorrencias/{ocorrenciaId} {
        allow read: if isSignedIn() && (resource.data.residentId == userId() || hasRole(resource.data.condominioId, "sindico") || isAdmin());
        allow list: if isSignedIn() && (hasRole(request.query.condominioId, "sindico") || isAdmin());
        allow create: if isSignedIn() && request.resource.data.residentId == userId();
        allow update: if isSignedIn() && (hasRole(resource.data.condominioId, "sindico") || isAdmin());
        allow delete: if false;
    }

    // Gate Records - only 'porteiro' and 'sindico' can manage.
    match /portaria_registros/{registroId} {
      allow read, create: if isSignedIn()
        && (hasRole(request.resource.data.condominioId, "porteiro")
            || hasRole(request.resource.data.condominioId, "sindico") || isAdmin());
      allow update, delete: if false; // Records should be immutable.
    }
    
    // General condo data (condos, blocks, units) is readable by members and writable by 'sindico'.
    match /condominios/{condominioId} {
        allow read: if isMember(condominioId);
        allow create, update, delete: if hasRole(condominioId, "sindico") || isAdmin();
        
        match /blocos/{blocoId} {
            allow read: if isMember(condominioId);
            allow create, update, delete: if hasRole(condominioId, "sindico") || isAdmin();
        }
        
        match /unidades/{unidadeId} {
            allow read: if isMember(condominioId);
            allow create, update, delete: if hasRole(condominioId, "sindico") || isAdmin();
        }
    }
  }
}
